<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Habitica Wiki Quest Table Creator</title>

<!--

This page outputs the wikia code for creating the Quest Table
in this page:
    http://habitica.fandom.com/ru/wiki/ XXX

This code is licenced under the same terms as Habitica:
    https://raw2.github.com/HabitRPG/habitrpg/develop/LICENSE

https://github.com/Alys/tools-for-habitrpg/blob/master/quest_table_creator.html

https://oldgods.net/habitrpg/quest_table_creator.html

Contributors:
    Alys (Alice Harris), lady_alys@oldgods.net
    Jazzis (Yuri Mashukov), jazzis18@gmail.com

-->

    <meta name="description" content="Habitica Wiki Quest Table Creator" />
    <meta name="author" content="Alys (Alice Harris) lady_alys@oldgods.net" />


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="//cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
    <link href="//cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css" />


<script type="text/javascript">
$(function() { // wraps around all our code to not pollute global namespace

var wikiaBaseUrl = 'http://habitica.fandom.com/ru/wiki/';

//////////////////////////////////////////////////////////////////////
////   RELEASE DATES FOR QUEST SCROLLS                 ///////////////
//////////////////////////////////////////////////////////////////////
var startOfTime = '2015-11';
var releaseDates = {
    'dilatory': startOfTime,
    'stressbeast': startOfTime,
    'burnout': startOfTime,
    'evilsanta': startOfTime,
    'evilsanta2': startOfTime,
    'gryphon': startOfTime,
    'hedgehog': startOfTime,
    'ghost_stag': startOfTime,
    'vice1': startOfTime,
    'vice2': startOfTime,
    'vice3': startOfTime,
    'egg': startOfTime,
    'rat': startOfTime,
    'octopus': startOfTime,
    'dilatory_derby': startOfTime,
    'atom1': startOfTime,
    'atom2': startOfTime,
    'atom3': startOfTime,
    'harpy': startOfTime,
    'rooster': startOfTime,
    'spider': startOfTime,
    'moonstone1': startOfTime,
    'moonstone2': startOfTime,
    'moonstone3': startOfTime,
    'goldenknight1': startOfTime,
    'goldenknight2': startOfTime,
    'goldenknight3': startOfTime,
    'basilist': startOfTime,
    'owl': startOfTime,
    'penguin': startOfTime,
    'trex': startOfTime,
    'trex_undead': startOfTime,
    'rock': startOfTime,
    'bunny': startOfTime,
    'slime': startOfTime,
    'sheep': startOfTime,
    'kraken': startOfTime,
    'whale': startOfTime,
    'dilatoryDistress1': startOfTime,
    'dilatoryDistress2': startOfTime,
    'dilatoryDistress3': startOfTime,
    'cheetah': startOfTime,
    'horse': startOfTime,
    'frog': startOfTime,
    'snake': startOfTime,
    'unicorn': '2015-12',
    'sabretooth' : '2016-01',
    'monkey' : '2016-02',
    'snail' : '2016-03',
    'falcon' : '2016-04',
    'bewilder' : '2016-04',
    'treeling' : '2016-05',
    'axolotl' : '2016-06',
    'turtle' : '2016-07',
    'armadillo' : '2016-08',
    'cow' : '2016-09',
    'beetle' : '2016-10',
    'taskwoodsTerror1' : '2016-10',
    'taskwoodsTerror2' : '2016-10',
    'taskwoodsTerror3' : '2016-10',
    'ferret' : '2016-11',
    'dustbunnies' : '2016-11',
    'moon1' : '2016-11',
    'moon2' : '2016-11',
    'moon3' : '2016-11',
    'sloth' : '2016-12',
    'triceratops' : '2017-01',
    'stoikalmCalamity1' : '2017-01',
    'stoikalmCalamity2' : '2017-01',
    'stoikalmCalamity3' : '2017-01',
    'guineapig' : '2017-02',
    'peacock' : '2017-03',
    'butterfly' : '2017-04',
    'mayhemMistiflying1' : '2017-04',
    'mayhemMistiflying2' : '2017-04',
    'mayhemMistiflying3' : '2017-04',
    'nudibranch' : '2017-06',
    'hippo' : '2017-08',
    'lostMasterclasser1' : '2017-10',
    'lostMasterclasser2' : '2017-10',
    'lostMasterclasser3' : '2017-10',
    'lostMasterclasser4' : '2017-10',
    'yarn' : '2017-11',
    'pterodactyl' : '2018-01',
    'badger' : '2018-02',
    'dysheartener' : '2018-02',
    'squirrel' : '2018-04',
    'seaserpent' : '2018-07',
    'kangaroo' : '2018-08',
    'alligator' : '2018-10',
    'velociraptor' : '2019-01',
    'bronze' : '2019-05',
    'dolphin' : '2019-07',
    'silver' : '2019-08',
};
// get the current month's date in case the latest quest
// hasn't been added above yet:
var d = new Date();
var month = d.getMonth() + 1;
var thisMonth = d.getFullYear() + '-' + ((month < 10) ? '0' : '') + month;


//////////////////////////////////////////////////////////////////////
////   SCROLL IMAGE FILE NAMES FOR EACH QUEST          ///////////////
////                                                   ///////////////
////   Add new entries here (in any order) when a new  ///////////////
////   quest becomes available.                        ///////////////
////   This is necessary only if the wiki image links  ///////////////
////   for the quest scroll do not match the file      ///////////////
////   names from Habitica.                            ///////////////
////                                                   ///////////////
////   DO NOT PUT SPACES IN THESE FILE NAMES!          ///////////////
//////////////////////////////////////////////////////////////////////
var images = {
    'evilsanta':    'Inventory_quest_scroll_evilsanta.png',
    'burnout':      'н/д',
    'stressbeast':  'н/д',
    'dilatory':     'н/д',
    'bewilder':     'н/д',
    'dysheartener': 'н/д',
};

//////////////////////////////////////////////////////////////////////
////   AVAILABILITY TEXT FOR **SOME** QUESTS           ///////////////
////                                                   ///////////////
////   Add new entries here (in any order) when        ///////////////
////   a new quest becomes available if and only if    ///////////////
////   its availability is not the standard            ///////////////
////   "permanent".                                    ///////////////
//////////////////////////////////////////////////////////////////////
var questAvailability = {
    'basilist':     'пригласить кого-нибудь в команду',
    'egg':          'только во время ' + make_url('Весенней веселухи', 'Весенняя_веселуха'),
    'evilsanta':    'только во время ' + make_url('Зимней страны чудес', 'Зимняя_страна_чудес'),
    'evilsanta2':   'только во время ' + make_url('Зимней страны чудес', 'Зимняя_страна_чудес'),
    'burnout':      'завершен',
    'stressbeast':  'завершен',
    'dilatory':     'завершен',
    'bewilder':     'завершен',
    'dysheartener': 'завершен',
};

//////////////////////////////////////////////////////////////////////
////   WIKI LINKS FOR **SOME** QUESTS                  ///////////////
////                                                   ///////////////
////   Add new entries here (in any order) when        ///////////////
////   a new quest becomes available.                  ///////////////
////   This is necessary only if the wiki page         ///////////////
////   filename does not match the filename that can   ///////////////
////   be created automatically from the quest's name. ///////////////
////                                                   ///////////////
////   DO NOT PUT SPACES IN THESE LINKS!               ///////////////
//////////////////////////////////////////////////////////////////////
var questPageUrls = {
    'atom1' : 'Мусорная_катастрофа!',
    'evilsanta2' : 'Найти_детеныша',
};

//////////////////////////////////////////////////////////////////////
////   LINKS FOR REWARDS (GEAR, ETC)                   ///////////////
////                                                   ///////////////
////   Add new entries here (in any order) when        ///////////////
////   a quest rewards you with equipment AND when     ///////////////
////   that equipment has its own wiki page.           ///////////////
////                                                   ///////////////
////   DO NOT PUT SPACES IN THESE LINKS!               ///////////////
//////////////////////////////////////////////////////////////////////
var rewardPageUrls = {
    'shield_special_goldenknight': 'Моргенштерн_Мастейна,_сминающий_мильные_метки',
    'weapon_special_2': 'Посох_дракона_Стивена_Уэбера',
    'head_special_2': 'Безымянный_шлем',
    'armor_special_2': 'Благородная_туника_Жана_Шалара',
};


//////////////////////////////////////////////////////////////////////
////   Global Variables                              /////////////////
//////////////////////////////////////////////////////////////////////
var content; // holds site-wide content (gear names and stats, quests, etc)
var serverUrl = 'https://habitica.com:443/api/v3';


//////////////////////////////////////////////////////////////////////
////   Data Fetch Function   /////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
fetchData();
function fetchData() {
    $('#loading .good').show();
    $('#loading .bad' ).hide();

    // fetch the site-wide content (quest names and stats, etc):
    $.ajax({
        url: serverUrl + '/content' + '?language=ru',
        type: 'GET',
        dataType: 'json',
        cache: true,
        success: fetchContentSuccess,
        error: fetchFailure
    });

    function fetchFailure() {
        $('#loading .good').hide();
        $('#loading .bad' ).show();
    }
    function fetchContentSuccess(data) {
        content = data.data;
        parseData();
    }
}

function parseData() {
    var allQuests = content.quests;
    var allQuestsStringified = JSON.stringify(allQuests, null, 4);

    // Get quest IDs and sort them in the desired display order
    // (world bosses at end because of least interest):
    var questIds    = [];
    var questIdsEnd = [];
    for (var questId in allQuests) {
        var quest = allQuests[questId];
        if (quest.category && quest.category === 'world') {
            questIdsEnd.push(questId);
        }
        else {
            questIds.push(questId);
        }
    }
    questIds = questIds.concat(questIdsEnd);

    // Find the first quest in each quest line:
    var questLineStartIds = {};
    for (var questId in allQuests) {
        var quest = allQuests[questId];
        if (quest.previous) {
            questLineStartIds[quest.previous] = true;
        }
    }

    var warnings = '';

    var headers = [ ' class="unfilterable" | Название',
                    ' class="unfilterable" | Свиток',
                    ' class="unfilterable" | Доступность',
                    ' class="unsortable"   | Тип',
                    ' class="unfilterable" | Награды',
                    ' class="unfilterable" | Золото',
                    ' class="unfilterable" | Опыт',
                    ' class="unfilterable" | Здоровье<br />босса',
                    ' class="unfilterable" | Сила<br />босса'];

    var headersHtml = ['название', 'свиток', 'доступность', 'тип', 'награды', 'золото', 'опыт', 'здоровье босса', 'сила босса'];
    headersHtml.push('<em>длительность</em>', '<em>сложность</em>', '<em>рейтинг</em>', '<em>дата выпуска</em>');

    // table row for each quest:
    var releaseDateNeeded = '';
    var tableRows    = { 'all':        [],
                         'easy':       [],
                         'medium':     [],
                         'hard':       [],
                         'questLines': [],
                       };
    var tableRowsHtml    = [];
    var devData = '';
    var latestQuestUpdatesNeeded = '';
    var allQuestRewardsBugFixNormal = '';
    var allQuestRewardsBugFixSpecial = '';
    for (var index = 0; index < questIds.length; index++) {
        var questId = questIds[index];
        var quest = allQuests[questId];
        // devData += "    '" + questId + "': startOfTime,\n";
        var row     = [];

        var questRewardsBugFixNormal = '';
        var questRewardsBugFixSpecial = '';
        questRewardsBugFixNormal += '"achievements.quests.' + questId + '":1, ';

        var questName = quest.text;
        row.push([ make_url(questName, questPageUrls[questId] || ''),
                   'data-sort-value="' + questName + '"' ]);

        row.push([ make_image(images[questId] ||
                             'Inventory_quest_scroll_' + questId + '.png',
                             questId),
                  'data-sort-value="' + questId + '"' ]);

        var availability = '';
        var displayLevelRestriction = false;
        if (quest.category && quest.category === 'unlockable') {
            if (quest.unlockCondition && quest.unlockCondition.text &&
                quest.unlockCondition.text === "Создать учетную запись"
               ) {
                availability = quest.unlockCondition.text.toLowerCase();
            }
            else if (quest.unlockCondition && quest.unlockCondition.incentiveThreshold) {
                var incentiveThreshold = quest.unlockCondition.incentiveThreshold;
                availability = make_url(
                    incentiveThreshold + ' ' +
                    pluralize(incentiveThreshold, 'вход', 'входа', 'входов') +
                    ' в игру', 'Ежедневное_вознаграждение'
                );
            }
            else if (quest.previous) {
                availability = 'пред. часть';
                displayLevelRestriction = quest.lvl; // true
            }
            else if (quest.lvl) {
                availability = quest.lvl + ' ур.';
            }
        }
        if (quest.unlockCondition && quest.unlockCondition.condition &&
            quest.unlockCondition.condition === 'party invite'
           ) {
            delete quest.value; // Habitica's config lies
        }
        var cost = (quest.goldValue) ? quest.goldValue + ' золота' :
                   (quest.value)     ? quest.value + ' самоцв.'
                                     : '';
        if (cost) {
            if (availability) {
                availability += ' или<br />';
            }
            availability += cost;
        }
        if (questAvailability[questId]) {
            if (availability) {
                availability += '<br />';
            }
            availability += questAvailability[questId];
        }
        if (displayLevelRestriction) {
            availability += '<br />(' + quest.lvl + ' ур.)';
        }
        row.push(availability);

        var objectiveType =
            (quest.category && quest.category === 'world') ? 'мировой босс' :
            (quest.collect) ? 'собираемый' :
            (quest.boss)    ? 'босс' :
                              'неизвестный';
        row.push(objectiveType);

        var droppedGP = quest.drop.gp || 0;
        var droppedXP = quest.drop.exp || 0;
        delete quest.drop.gp;
        delete quest.drop.exp;
        var XPandGPonly = jQuery.isEmptyObject(quest.drop);
        questRewardsBugFixNormal += '"stats.gp":' + droppedGP + ', "stats.exp":' + droppedXP + ', ';

        // if (quest.drop.unlock) { console.log(quest.drop.unlock); } // TST
        delete quest.drop.unlock;

        var items = {};
        if (quest.drop.items) {
            for (var i in quest.drop.items) {
                var obj = quest.drop.items[i];
                if (!items[obj.type]) {
                    items[obj.type] = {}; // e.g., "eggs", "gear"
                }
                if (!items[obj.type][obj.key]) {
                    items[obj.type][obj.key] = {}; // e.g., Potatoe
                }
                items[obj.type][obj.key]['text'] = obj.text; // e.g., Potato
                if (!items[obj.type][obj.key]['count']) {
                    items[obj.type][obj.key]['count'] = 0;
                }
                items[obj.type][obj.key]['count']++;
                delete obj.type;
                delete obj.key;
                delete obj.text;
                if (Object.keys(obj).length) {
                    console.log('"obj" object has other contents:');
                    console.log(obj);
                }
            }
        }
        delete quest.drop.items;
        if (Object.keys(quest.drop).length) {
            console.log('"quest.drop" object has other contents:');
            console.log(quest.drop);
        }

        var petName   = '';
        var mountName = '';
        var equipment = [];
        var other     = [];
        for (var type in items) {
            if (type === 'food' && quest.category === 'world') {
                other.push("по одной ед. еды каждого вида"); // ASSUME this happens for each world quest
            }
            else {
                for (var key in items[type]) {
                    var text = items[type][key]['text'];
                    var bugFixValue = 'UNKNOWN';
                    if (type === 'pets') {
                        // ASSUME this key doesn't appear in rewardPageUrls
                        // ASSUME there's no more than one pet
                        petName = text.replace(/ +\([Пп]итомец\)/i, '');
                        bugFixValue = 5;
                    }
                    else if (type === 'mounts') {
                        // ASSUME this key doesn't appear in rewardPageUrls
                        // ASSUME there's no more than one mount
                        mountName = text.replace(/ +\([Сс]какун\)/i, '');
                        bugFixValue = 'true'; // string!
                    }
                    else {
                        if (type === 'gear') {
                            text = text.replace(/ +\((оружие для защитной руки|оружие|для защитной руки|доспехи|головной убор)\)/i, '');
                            bugFixValue = 'true'; // string!
                        }
                        else if (type === 'eggs') {
                            text = text.replace(/\([Яя]йцо\)/i, '(яйцо)');
                            bugFixValue = items[type][key]['count'];
                        }
                        else if (type === 'hatchingPotions') {
                            var myRegexpPotion = /[Ии]нкубационный [Ээ]ликсир [Зз]омби/g;
                            var match = myRegexpPotion.exec(text);
                            if (match) {
                                text = text.replace(/[Ии]нкубационный [Ээ]ликсир [Зз]омби/i, 'Инкубационный эликсир зомби');
                            }
                            else {
                                text = text.replace(/[Ии]нкубационный [Ээ]ликсир/i, 'инкубационный эликсир');
                            }
                            bugFixValue = items[type][key]['count'];
                        }
                        else if (type === 'food') {
                            text = text.replace(/[Ее]да/i, 'еда');
                            bugFixValue = items[type][key]['count'];
                        }
                        else {
                            bugFixValue = items[type][key]['count'];
                        }
                        if (rewardPageUrls[key]) {
                            text = make_url(text, rewardPageUrls[key]);
                        }
                        if (items[type][key]['count'] > 1) {
                            text += ' x ' + items[type][key]['count'];
                        }
                        if (type === 'gear') {
                            equipment.push(text);
                        }
                        else {
                            other.push(text);
                        }
                    }
                    if (type === 'gear') {
                        questRewardsBugFixSpecial += '"items.' + type + '.owned.' + key + '":' + bugFixValue + ', ';
                    }
                    else {
                        questRewardsBugFixNormal += '"items.' + type + '.' + key + '":' + bugFixValue + ', ';
                    }
                }
            }
        }

        if (petName && mountName && petName === mountName) {
            var pets = petName + ' (питомец и скакун)';
            other.unshift(pets);
        }
        else {
            if (petName) {
                other.unshift(petName + ' (питомец)');
            }
            if (mountName) {
                other.unshift(mountName + ' (скакун)');
            }
        }
        var rewardItems = equipment.concat(other);

        var specialRewardType = 'неизвестно';
        var etcPossible = false;
        if (XPandGPonly) {
            specialRewardType = 'только<br />опыт и золото';
        }
        if (items['gear']) {
            specialRewardType = 'снаряжение';
            etcPossible = true;
            delete items['gear'];
        }
        if (items['quests']) {
            specialRewardType = 'свиток';
            etcPossible = true;
            delete items['quests'];
        }
        if (etcPossible && Object.keys(items).length) {
            specialRewardType += ', и др.';
        }
        var rewardType =
            (!quest.category)                     ? specialRewardType :
            (quest.category === 'world')          ? 'разное'          :
            (quest.category === 'gold')           ? specialRewardType :
            (quest.category === 'unlockable')     ? specialRewardType :
            (quest.category === 'pet')            ? 'питомец'         :
            (quest.category === 'hatchingPotion') ? 'эликсир'         :
                                                     quest.category; // e.g., pet

        // add list of rewards to reward type, with some abbreviations:
        var itemsString = rewardItems.join(';<br />');
        if (rewardType === 'свиток') {
            itemsString = itemsString.replace(/ \([Сс]виток\)/i, '');
            itemsString = itemsString.replace(/ \([Кк]вестовый [Сс]виток\)/i, '');
            itemsString = itemsString.replace(/.*[Чч]асть [0-9]: /i, '');
        }

        if (itemsString) {
            rewardType += ':<br />' + itemsString;
        }

        row.push(rewardType);

        row.push(droppedGP);
        row.push(droppedXP);

        var bossHP     = 'н/д';
        var bossHPSort = 0;
        var bossStr    = 'н/д';
        var bossRage   = '';
        var questLength         = 'н/д';
        var questLengthDetailed = 'н/д';
        var questDifficulty     = 'н/д';
        if (quest.boss) {
            bossHP     = quest.boss.hp   || 0;
            bossHPSort = bossHP;
            bossStr  = quest.boss.str  || 0;
            bossRage = (quest.boss.rage && quest.boss.rage.value) ? +quest.boss.rage.value : 0;
            if ((!quest.category || quest.category !== 'world')) {
                if (bossHP > 999) {
                    questLength = '3. длинная';
                }
                else if (bossHP > 499) {
                    questLength = '2. средняя';
                }
                else {
                    questLength = '1. короткая';
                }

                if (bossHP > 1200) {
                    questLengthDetailed = '> 4 нед.';
                }
                else if (bossHP > 1000) {
                    questLengthDetailed = '~ 4 нед.';
                }
                else if (bossHP > 900) {
                    questLengthDetailed = '3-4 нед.';
                }
                else if (bossHP > 799) {
                    questLengthDetailed = '~ 3 нед.';
                }
                else if (bossHP > 500) {
                    questLengthDetailed = '2-3 нед.';
                }
                else if (bossHP > 400) {
                    questLengthDetailed = '~ 2 нед.';
                }
                else if (bossHP > 300) {
                    questLengthDetailed = '< 2 нед.';
                }
                else {
                    questLengthDetailed = '~ 1 нед.';
                }

                if (bossStr > 2.5) {
                    questDifficulty = '5. очень сложно';
                }
                else if (bossStr === 2.5) {
                    questDifficulty = '4. сложно';
                }
                else if (bossStr >= 2) {
                    questDifficulty = '3. средне';
                }
                else if (bossStr >= 1.5) {
                    questDifficulty = '2. легко';
                }
                else {
                    questDifficulty = '1. пустяк';
                }
            }

            var divisor = 1000 * 1000;
            if (bossHP > divisor) {
                bossHP = bossHP / divisor;
                bossHP += ' млн.';
            }
            if (bossRage && bossRage > divisor/10) {
                bossRage = bossRage / divisor;
                bossRage += ' млн.';
            }
        }
        else if (quest.collect) {
            var count = 0;
            for (var i in quest.collect) {
                if (quest.collect[i].count) {
                    count += quest.collect[i].count;
                }
            }

            if (count > 300) {
                questDifficulty = '5. очень сложно';
                questLength = '3. длинная';
                questLengthDetailed = '';
            }
            else if (count > 100) {
                questDifficulty = '4. сложно';
                questLength = '3. длинная';
                questLengthDetailed = '';
            }
            else if (count > 30) {
                questDifficulty = '3. средне';
                questLength = '2. средняя';
                questLengthDetailed = '';
            }
            else {
                questDifficulty = '2. легко';
                questLength = '1. короткая';
                questLengthDetailed = '';
            }
        }

        var rating = 'неизвестно';
        if (quest.category && quest.category === 'world') {
            rating = '4. н/д';
        }
        else if ((questDifficulty === '1. пустяк' ||
             questDifficulty === '2. легко') && questLength === '1. короткая'
           ) {
            rating = '1. легкий';
        }
        else if ( questDifficulty >= '4. сложно' ||
                 (questDifficulty === '3. средне' && questLength === '3. длинная')
                ) {
            rating = '3. сложный';
        }
        else {
            rating = '2. средний';
        }

        row.push([ bossHP + ((bossRage) ? '<br />ярость: '+bossRage : ''),
                   'data-sort-value="' + bossHPSort + '"' ]);
        row.push(bossStr);

        var myRegexpLink  = /(.*)\[(\S+) +([^\]]+)\](.*)/g;            // '[' + url + ' ' + text + ']';
        var myRegexpImage = /(.*)\[\[File:([^\|]+)\|[^\]]+\]\](.*)/g;  // '[[File:' + image + '|' + hoverText + ']]';

        // So far, row contains the table cells for a Wikia table.
        // We now create an HTML version, and then add more fields to that.
        var rowHtml = [];
        for (var i in row) {
            var valueObj = row[i];
            var value  = '';
            if (Object.prototype.toString.call(valueObj) === '[object Array]') {
                value  = valueObj[0];
                // ignore second element which is a wikia table config string
            }
            else {
                value = valueObj;
            }

            // replace Wikia links and images with HTML versions (we ASSUME there's at most ONE link and ONE image per table cell):
            var match = myRegexpLink.exec(value);
            if (match) {
                value = match[1] + '<a href="' + match[2] + '">' + match[3] + '</a>' + match[4];
            }
            var match = myRegexpImage.exec(value);
            if (match) {
                value = match[1] + '<img src="' + 'fake_broken_image' + '" />' + match[3]; // no image because it won't work anyway
                value += '<br />' + questId;
            }

            rowHtml.push(value);
        }

        // It would be better if the wiki pages had internal links, rather than external ones that link to wiki pages.
        // Therefore, after forming the row for the HTML table, we make the links internal again.
        var myRegexpLink = /(.*)\[((http|https)?:\/\/)?(\w+\.fandom\.com)(\/\w+)?(\/wiki\/)?(.+?)\s(.+)\](.*)/g;
        var match = myRegexpLink.exec(row[0]);
        if (match) {
            if (match[7] === match[8].replace(/ /g, '_')) {
                row[0] = '[[' + match[8] + ']]';
            }
            else {
                row[0] = '[[' + match[7] + '|' + match[8] + ']]';
            }
        }
        var myRegexpLink = /(.*)\[((http|https)?:\/\/)?(\w+\.fandom\.com)(\/\w+)?(\/wiki\/)?(.+?)\s(.+)\](.*)/g;
        var match = myRegexpLink.exec(row[2]);
        if (match) {
            if (match[7] === match[8].replace(/ /g, '_')) {
                row[2] = match[1] + '[[' + match[8] + ']]' + match[9];
            }
            else {
                row[2] = match[1] + '[[' + match[7] + '|' + match[8] + ']]' + match[9];
            }
        }
        var myRegexpLink = /(.*)\[((http|https)?:\/\/)?(\w+\.fandom\.com)(\/\w+)?(\/wiki\/)?(.+?)\s(.+)\](.*)/g;
        var match = myRegexpLink.exec(row[4]);
        if (match) {
            if (match[7] === match[8].replace(/ /g, '_')) {
                row[4] = match[1] + '[[' + match[8] + ']]' + match[9];
            }
            else {
                row[4] = match[1] + '[[' + match[7] + '|' + match[8] + ']]' + match[9];
            }
        }

        rowHtml.push(questLength + ((questLengthDetailed) ?
                    '<br />(' + questLengthDetailed + ')' : ''));
        rowHtml.push(questDifficulty);
        rowHtml.push(rating);

        var releaseDate       = '';
        var releaseDatePretty = '';
        if (! releaseDates[questId]) {
            releaseDateNeeded += "'" + questId +"' : '"+ thisMonth + "',<br />";
        }
        releaseDate = releaseDates[questId] || thisMonth;
        if (releaseDate === startOfTime) {
            releaseDatePretty = releaseDate + '<br />или раньше';
        }
        else {
            releaseDatePretty = releaseDate;
        }
        rowHtml.push(releaseDatePretty);

        // We now have the `row` array which contains Wikia code for
        // this quest, and the `rowHtml` array which contain HTML code.
        // We save the `row` array into one or more collections of
        // quests, depending on the parameters of this quest.
        // For the HTML table, there is only one collection.

        if (releaseDate === thisMonth) {
            latestQuestUpdatesNeeded += "Квест <strong>" + questName + "</strong> был выпущен в этом месяце. Требуется обновление для таблиц: Все квесты";
        }

        if (quest.previous || questId.match(/evilsanta/) || questLineStartIds[questId]) {
            tableRows.questLines.push( convertRow('wikia', row) );
            if (releaseDate === thisMonth) { latestQuestUpdatesNeeded += ", Квестовые линии"; }
        }

        tableRowsHtml.push(rowHtml);
        tableRows.all.push( convertRow('wikia', row) );

        if (rating === '1. легкий') {
            tableRows.easy.push( convertRow('wikia', row) );
            if (releaseDate === thisMonth) { latestQuestUpdatesNeeded += ", Легкие квесты"; }
        }
        else if (rating === '2. средний') {
            tableRows.medium.push( convertRow('wikia', row) );
            if (releaseDate === thisMonth) { latestQuestUpdatesNeeded += ", Средние квесты"; }
        }
        else if (rating === '3. сложный') {
            tableRows.hard.push( convertRow('wikia', row) );
            if (releaseDate === thisMonth) { latestQuestUpdatesNeeded += ", Сложные квесты"; }
        }
        if (releaseDate === thisMonth) {
            latestQuestUpdatesNeeded += ".<br />";
            allQuestRewardsBugFixNormal += '// ' + questRewardsBugFixNormal + '  // ' + questId + ' : ' + quest.text;
            if (questRewardsBugFixSpecial) {
                allQuestRewardsBugFixNormal += '  // ALSO SPECIAL REWARD';
                allQuestRewardsBugFixSpecial += '// ' + questRewardsBugFixSpecial + '  // ' + questId + ' : ' + quest.text;
                allQuestRewardsBugFixSpecial += '<br />';
            }
            allQuestRewardsBugFixNormal += '<br />';
        }
    }

    var questTableHeader = '' +
'\n{| class="filterable sortable" border="1" cellpadding="2" cellspacing="0" style="font-size: 13px; width: 100%; text-align: center; background: #F2F2F2; border:5px solid #F2F2F2;"' +
'\n|- style="background: #284C6D; color: #FFFFFF; white-space: nowrap;"' +
    convertRow('wikia', headers, 'th');

    var questTableFooter = '' +
'\n|- class="sortbottom"' +
'\n| colspan="10" style="height: 0px; border-bottom: 3px solid #284C6D;"|' +
'\n|}\n';


    // create HTML table showing production data and development data:
    var columns = [];
    for (var i in headersHtml) {
        columns.push({'title': headersHtml[i]});
    }
    $(document).ready(function() {
        $('#theTable').DataTable( {
            'data': tableRowsHtml,
            'columns': columns,
            'bPaginate': false,
            'aaSorting': [], // no default sorting
        } );
    } );

    var htmlEnd = '';
    if (releaseDateNeeded) {
        htmlEnd  += '<p>NOTES FOR ALYS:<br />Need release date:<br />' + releaseDateNeeded +
                    // 'Rewards:<br />' + allQuestRewardsBugFixSpecial + allQuestRewardsBugFixNormal +
                    '</p>';

    }
    if (warnings) htmlEnd += '<p>WARNING:<br />' + warnings + '</p>';
    if (false) { // FOR TESTING
        htmlEnd += "<p>The material below here is Habitica's JSON data that" +
                " was used to make the wikia code above. You can ignore it" +
                " unless you are interested in it. You do not need to" +
                " copy it to the wiki.</p>" +
                "<pre>" + allQuestsStringified + "</pre>";
    }
    if (devData) {
        htmlEnd += '<pre>' + devData + '</pre>';
    }


    //////////////////////////////////////////////////////////////////////
    ////   Display the HTML    ///////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////

    // XXX use wikiaBaseUrl in text below
    var htmlStart = '';
    ////// var htmlStart = '<p>This page outputs the wikia code for creating tables'
        ////// + ' on the <a href="http://habitica.fandom.com/">Habitica wiki</a>.'
        ////// + ' One table is for the [XXX finish this ... quest table pages ] '
        // + ' <a href="http://habitica.fandom.com/wiki/Equipment_Table">'
        // + 'Equipment Table</a> page, and the other is for the'
        // + ' <a href="http://habitica.fandom.com/wiki/Enchanted_Armoire">'
        // + 'Enchanted Armoire</a> page.</p>'
        // + '<p>Copy everything inside each textarea below and paste it '
        // + 'into the appropriate template pages: <a href="'
        // + 'http://habitica.fandom.com/wiki/Template:Equipment_Table_Code'
        // + '">Template:Equipment_Table_Code</a> and <a href="'
        // + 'http://habitica.fandom.com/wiki/Template:Enchanted_Armoire_Table_Code'
        // + '">Template:Enchanted_Armoire_Code</a>.'
        ////// + '</p>';

    $('#loading .good').hide();
    $('#output').html(htmlStart +
        '<p>' + latestQuestUpdatesNeeded + '</p>' +
        '<h2>Примечания:</h2>' +
        '<ul>' +
        '<li>Если у вас есть какие-нибудь предложения по улучшению, пишите их в гильдию «Wizards of the Wiki».</li>' +

        '<li>Столбцы <strong>длительность</strong>, <strong>сложность</strong> и <strong>рейтинг</strong> не отображаются в вики, но они включены в таблицу ниже, чтобы помочь нам классифицировать квесты по страницам.</li>' +
        '<li>Столбец <strong>дата выпуска</strong> не отображается в вики. Он используется здесь только для того, чтобы помочь нам определить, какие страницы необходимо обновлять при выпуске нового квеста, поэтому точные даты выхода для большинства квестов не включены.</li>' +

        '<li>Изображения квестовых свитков в HTML-таблице никогда не будут работать, но в вики всё будет нормально.</li>' +
        '<li>Сортировка в HTML-таблице не всегда работает правильно, но в вики всё будет нормально.</li>' +

        '<li>Любая информация, полученная из Habitica, должна быть правильной. Любые данные, которые Alys могла использовать для вычислений, могут быть неверными. Все ошибки можно легко исправить.</li>' +

        '</ul>' +

        '<h3>Длительность, сложность и рейтинг</h3>' +
        '<ul>' +
        '<li>Для квеста босса:' +
            '<ul>' +
            '<li>Если здоровье босса:' +
                '<ul>' +
                '<li>равно 1000 или выше, то длительность будет «длинная»;</li>' +
                '<li>500 и выше – «средняя»;</li>'+
                '<li>остальные – «короткая».</li>' +
                '</ul>' +
            '</li>' +
            '<li>Если сила босса:' +
                '<ul>' +
                '<li>больше, чем 2,5, то сложность будет «очень сложно»;</li>' +
                '<li>равна 2,5 – «сложно»;</li>' +
                '<li>2 или выше – «средне»;</li>' +
                '<li>1,5 или выше – «легко»;</li>' +
                '<li>остальные – «пустяк».</li>' +
                '</ul>' +
            '</li>' +
            '</ul>' +
        '</li>' +
        '<li>Для собираемого квеста, если требутся собрать:' +
            '<ul>' +
            '<li>больше, чем 300 предметов, то сложность будет «очень сложно», а длительность – «длинная»;</li>' +
            '<li>больше, чем 100 – «очень сложно» и «длинная»;</li>' +
            '<li>больше, чем 30 – «средне» и «средняя»;</li>' +
            '<li>меньше, чем выше – «легко» и «короткая».</li>' +
            '</ul>' +
        '</li>' +
        '<li>Рейтинг – это объединение длительности и сложности. Если сложность квеста «пустяк» или «легко», а длительность «короткая», то его рейтинг будет «легкий». Если сложность квеста «сложно» или он «длинный», но «средней» сложности, то его рейтинг – «сложный». У остальных рейтинг – «средний».</li>' +
        '</ul>' +

        '<h2>Все квесты</h2>' +
        '<p>Эта текстовая область содержит код для создания вики-таблицы, отображющей все квесты. Вставьте этот код в шаблон <a href="http://habitica.fandom.com/ru/wiki/Шаблон:Таблица_квестов">Таблица квестов</a>.</p>' +
        '<textarea rows="10" cols="100" wrap="off">' +
        questTableHeader +
        tableRows.all.join("") +
        questTableFooter +
        '</textarea>' +

        '<h2>Квестовые линии</h2>' +
        '<p>Эта текстовая область содержит код для создания вики-таблицы, показывающей только квесты, которые относятся к квестовым линиям. Вставьте этот код в шаблон <a href="http://habitica.fandom.com/ru/wiki/Шаблон:Таблица_квестов/Квестовые_линии">Таблица квестов/Квестовые линии</a>.</p>' +
        '<textarea rows="10" cols="100" wrap="off">' +
        questTableHeader +
        tableRows.questLines.join("") +
        questTableFooter +
        '</textarea>' +

        '<h2>Легкие квесты</h2>' +
        '<p>Эта текстовая область содержит код для создания вики-таблицы, показывающей только легкие квесты. Вставьте этот код в шаблон <a href="http://habitica.fandom.com/ru/wiki/Шаблон:Таблица_квестов/Легкие_квесты">Таблица квестов/Легкие квесты</a>.</p>' +
        '<textarea rows="10" cols="100" wrap="off">' +
        questTableHeader +
        tableRows.easy.join("") +
        questTableFooter +
        '</textarea>' +

        '<h2>Средние квесты</h2>' +
        '<p>Эта текстовая область содержит код для создания вики-таблицы, показывающей только средние квесты. Вставьте этот код в шаблон <a href="http://habitica.fandom.com/ru/wiki/Шаблон:Таблица_квестов/Средние_квесты">Таблица квестов/Средние квесты</a>.</p>' +
        '<textarea rows="10" cols="100" wrap="off">' +
        questTableHeader +
        tableRows.medium.join("") +
        questTableFooter +
        '</textarea>' +

        '<h2>Сложные квесты</h2>' +
        '<p>Эта текстовая область содержит код для создания вики-таблицы, показывающей только сложные квесты. Вставьте этот код в шаблон <a href="http://habitica.fandom.com/ru/wiki/Шаблон:Таблица_квестов/Сложные_квесты">Таблица квестов/Сложные квесты</a>.</p>' +
        '<textarea rows="10" cols="100" wrap="off">' +
        questTableHeader +
        tableRows.hard.join("") +
        questTableFooter +
        '</textarea>' +

        '<p>Ниже представлена HTML версия таблицы, которая показывает все квесты (но с некоторыми отличиями от таблиц, которые вы найдете в вики):</p>' +
        htmlEnd);
}


function convertRow(format, rowArray, cellType) {
    // format is 'html' or 'wikia'
    var html = (format === 'html') ? true : false;
    cellType = cellType || 'td'; // 'th' can be specified manually
    if (!html) {
        cellType = (cellType === 'td') ? '|' : '!'; // Wikia versions of td and th
    }

    var row = (html) ? '<tr>' : ((cellType === '|') ? '\n|-' : '');
    for (var i in rowArray) {
        var valueObj = rowArray[i];
        var value  = '';
        var config = '';
        if (Object.prototype.toString.call(valueObj) === '[object Array]') {
            value  = valueObj[0];
            config = valueObj[1] + ' | ';
        }
        else {
            value = valueObj;
        }

        row += (html) ?
            '<'  + cellType + '>' :
            '\n' + cellType;
        row += config + value;
        row += (html) ?
            '</' + cellType + '>' :
            '';
    }
    row += (html) ? '</tr>\n' : '';
    return row;
}


function pluralize(number, one, two, five) {
    let n = Math.abs(number);
    n %= 100;
    if (n >= 5 && n <= 20) {
        return five;
    }
    n %= 10;
    if (n === 1) {
        return one;
    }
    if (n >= 2 && n <= 4) {
        return two;
    }
    return five;
}


function make_url(text, url) {
    if (!url) {
        url = text.replace(/ /g, '_');
        url = url.replace(/.*[Чч]асть_[0-9]:_/, ''); // e.g., convert Terror_in_the_Taskwoods,_Part_3:_Jacko_of_the_Lantern to Jacko_of_the_Lantern
    }
    if (url.indexOf('://') === -1) {
        url = wikiaBaseUrl + url;
    }
    return '[' + url + ' ' + text + ']';
    // return [ '<a href="' + url + '">' + text + '</a>',
             // '[[' + url + '|' + text + ']]'           ];
    // return (html) ? '<a href="' + url + '">' + text + '</a>' :
                    // '[[' + url + '|' + text + ']]';
}


function make_image(image, hoverText) {
    if (!image) {
        return '';
    }
    if (image === 'н/д') {
        return image;
    }
    hoverText = hoverText || '';
    return '[[File:' + image + '|' + hoverText + ']]';
    // return [ '<img src="null" />',
             // '[[File:' + image + ']]' ];
    // return (html) ? '<img src="null" />' :
                    // '[[File:' + image + ']]';
}


});
</script>

<style>
/*********************************************************************
****   Page-wide   ***************************************************
*********************************************************************/
body {
    font-family: Helvetica, Arial, sans-serif;
    font-size: 14px;
    background-color: rgb(173, 208, 215);
}
#innerBody {
    margin: 20px;
    padding: 5px 20px 30px 20px;
    background-color: rgb(242, 242, 230);
}
#loading {
    margin-right: 30px;
    margin-left: 30px;
    color: orange;
    font-size: 1.5em;
    font-weight: bold;
}
#loading ul {
    font-size: 0.8em;
}
#loading ul a {
    color: orange;
}


hr {
    width: 95%;
}
hr.padded {
    margin-top:    1em;
    margin-bottom: 2em;
}

.show {
    display: block;
}
.hide {
    display: none;
}
.clear {
    clear: both;
}

.subheading {
    font-weight: bold;
}
.highlight {
    font-weight: bold;
}
.lowlight { /* like highlight but less so */
    font-style: italic;
}
.explanation {
    font-style: italic;
}
abbr {
    border-bottom: 1px dashed black;
}
img.emoji {
    margin-bottom: -0.25em;
}
.forCopyPaste {
    /* used to add blank lines that we want when copying text to clipboard,
       but we don't want to see extra whitespace on the screen */
    margin-top: -1em;
}
ul.padded > li {
    padding: 3px 0;
}

.gearList .item .stats {
    font-variant: small-caps;
}
.gearList .item .key {
    display: none;
}


.coloured {
    display: inline-block;
    width: 5.5em;
    height: 3em;
    padding-top: .7em;
}
.colourBrightBlue { background-color: rgb(209,226,248); }
.colourBlueGrey   { background-color: rgb(216,230,232); }
.colourGreen      { background-color: rgb(222,237,219); }
.colourYellow     { background-color: rgb(255,244,216); }
.colourOrange     { background-color: rgb(254,234,216); }
.colourRed        { background-color: rgb(250,214,214); }
.colourDarkRed    { background-color: rgb(240,197,190); }

.neutral {
    background-color: #fffbd0; /* yellow */
}
.danger {
    background-color: #ffcccc; /* red */
}
.safe {
    background-color: #ccffcc; /* green */
}


/*********************************************************************
****   Header   ******************************************************
*********************************************************************/
h1 {
    float: left;
}
h1>a:first-child { /* "Habitica" link in header */
    color: black;
    text-decoration: none;
}
h1>a:first-child:hover { /* "Habitica" link in header */
    text-decoration: underline;
}
h1 span {
    font-size: 0.5em;
}


/*********************************************************************
****   Header   ******************************************************
*********************************************************************/
table {
    width: 100%;
    border-collapse: collapse;
}
table, th, td {
   border: 1px solid black;
}
th em {
    font-weight: normal;
}


</style>
</head>
<body><div id="innerBody">

<h1><a href="https://habitica.fandom.com/">Habitica Wiki</a> Quest Table Creator
    <span>(посл. обновление 14 августа 2019)</span></h1><!-- VERSION -->
<hr class="clear" />

<div id="loading">
    <div class="good hide">
        <p>Пожалуйста, подождите. Получение данных из Habitica...</p>
    </div>
    <div class="bad hide">
        <p>There was an error obtaining the data.</p>
        <ul class="padded">
            <li>Please reload the page (but perhaps wait half an hour first in case Habitica is under heavy load).</li>
            <li>If you're using Internet Explorer, try another browser. <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> or <a href="https://www.mozilla.org/en-US/firefox/new/">Firefox</a> will be more reliable.</li>
            <li>If neither of those help, <a href="mailto:lady_alys@oldgods.net">contact me</a>!</li>
        </ul>
    </div>
</div>

<div id="output">
</div>


<br />
<table id="theTable"></table>

<!--
== Table of All Quests in Quest Lines ==
{{:Template:Quest_Table_Quest_Lines}}

<noinclude>
Do not edit this table by hand. Instead, use the "Quest Lines" section in the [https://oldgods.net/habitrpg/quest_table_creator.html Quest Table Creator], which will read the latest "content" data from Habitica and create all the required wikia code. Delete everything below this "noinclude" tag and replace it with that code.
[[Category:Template Tables| ]][[Category:Habitica Templates]]
</noinclude>
-->

</div><!-- end of div id="innerBody" -->
</body>
</html>
